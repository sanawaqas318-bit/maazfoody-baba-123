<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcements - MAAZ Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>MAAZ Admin</h2>
            </div>
            <nav class="admin-nav">
                <a href="/admin" class="nav-item">ğŸ“Š Dashboard</a>
                <a href="/admin/users" class="nav-item">ğŸ‘¥ Users</a>
                <a href="/admin/products" class="nav-item">ğŸ“¦ Products</a>
                <a href="/admin/sales" class="nav-item">ğŸ’° Sales</a>
                <a href="/admin/announcements" class="nav-item active">ğŸ“¢ Announcements</a>
                <a href="/admin/logout" class="nav-item">ğŸšª Logout</a>
            </nav>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <div class="header-left">
                    <h1>ğŸ“¢ Announcements Manager</h1>
                    <p class="header-subtitle">Post updates and promotional messages to your customers</p>
                </div>
                <button class="btn-edit" style="background-color: #ffca28;" onclick="showAddAnnouncement()">â• New Announcement</button>
            </header>

            <!-- Statistics Section -->
            <div class="dashboard-section">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="stat-card">
                        <h3>ğŸ“Š Total Announcements</h3>
                        <p class="stat-value" id="totalAnnouncements">0</p>
                    </div>
                    <div class="stat-card stat-success">
                        <h3>âœ… Active Announcements</h3>
                        <p class="stat-value" id="activeAnnouncements">0</p>
                    </div>
                </div>
            </div>

            <!-- Announcements List -->
            <section class="orders-section">
                <div class="section-header">
                    <h2>ğŸ—‚ï¸ All Announcements</h2>
                    <input type="text" id="searchAnnouncements" placeholder="ğŸ” Search announcements..." class="search-box">
                </div>
                
                <div id="announcementList">
                    {% if announcements %}
                    <div style="display: grid; gap: 1.5rem;">
                        {% for ann in announcements %}
                        <div class="announcement-card">
                            <div class="announcement-header">
                                <div class="announcement-meta">
                                    <h3 class="announcement-title">{{ ann.title }}</h3>
                                    <span class="announcement-badge">ğŸ“Œ Active</span>
                                </div>
                                <div class="announcement-actions">
                                    <button class="btn-small btn-secondary" onclick="editAnnouncement({{ ann.id }}, '{{ ann.title }}', '{{ ann.message }}')">âœï¸ Edit</button>
                                    <button class="btn-small btn-danger" onclick="deleteAnnouncement({{ ann.id }})">ğŸ—‘ï¸ Delete</button>
                                </div>
                            </div>
                            <div class="announcement-content">
                                <p>{{ ann.message }}</p>
                            </div>
                            <div class="announcement-footer">
                                <span class="announcement-date">ğŸ“… {{ ann.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <p style="font-size: 3rem;">ğŸ“­</p>
                        <p>No announcements yet</p>
                        <button class="btn-primary" onclick="showAddAnnouncement()">Create First Announcement</button>
                    </div>
                    {% endif %}
                </div>
            </section>
        </main>
    </div>

    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ“¢ Create New Announcement</h2>
                <button class="close-btn" onclick="closeAnnouncement()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="announcementForm">
                    <div class="form-group">
                        <label for="annTitle">ğŸ“ Announcement Title</label>
                        <input type="text" id="annTitle" class="form-control" placeholder="Enter announcement title" required>
                        <small id="titlecharCount" style="color: #999; font-size: 0.8rem;">0/100 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="annMessage">ğŸ’¬ Message</label>
                        <textarea id="annMessage" class="form-control" placeholder="Enter your announcement message here..." rows="5" required></textarea>
                        <small id="messageCharCount" style="color: #999; font-size: 0.8rem;">0/500 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="annCategory">ğŸ·ï¸ Category (Optional)</label>
                        <select id="annCategory" class="form-control">
                            <option value="">-- Select Category --</option>
                            <option value="Promotion">ğŸ‰ Promotion</option>
                            <option value="Update">ğŸ“° Update</option>
                            <option value="Breaking">âš¡ Breaking News</option>
                            <option value="Maintenance">ğŸ”§ Maintenance</option>
                            <option value="Other">ğŸ“Œ Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAnnouncement()">Cancel</button>
                <button class="btn-primary" id="submitBtn" onclick="saveAnnouncement()">Post Announcement</button>
            </div>
        </div>
    </div>

    <script>
        let editingAnnounceId = null;

        function showAddAnnouncement() {
            editingAnnounceId = null;
            document.getElementById('announcementModal').classList.add('active');
            document.getElementById('announcementForm').reset();
            document.getElementById('modalTitle').textContent = 'ğŸ“¢ Create New Announcement';
            document.getElementById('submitBtn').textContent = 'Post Announcement';
            updateCharCount();
        }

        function editAnnouncement(id, title, message) {
            editingAnnounceId = id;
            document.getElementById('annTitle').value = title;
            document.getElementById('annMessage').value = message;
            document.getElementById('modalTitle').textContent = 'âœï¸ Edit Announcement';
            document.getElementById('submitBtn').textContent = 'Update Announcement';
            document.getElementById('announcementModal').classList.add('active');
            updateCharCount();
        }

        function closeAnnouncement() {
            document.getElementById('announcementModal').classList.remove('active');
            document.getElementById('announcementForm').reset();
            editingAnnounceId = null;
            updateCharCount();
        }

        function updateCharCount() {
            const titleInput = document.getElementById('annTitle');
            const messageInput = document.getElementById('annMessage');
            
            document.getElementById('titlecharCount').textContent = (titleInput.value.length) + '/100 characters';
            document.getElementById('messageCharCount').textContent = (messageInput.value.length) + '/500 characters';
        }

        // Add event listeners for character count
        document.getElementById('annTitle')?.addEventListener('input', updateCharCount);
        document.getElementById('annMessage')?.addEventListener('input', updateCharCount);

        function saveAnnouncement() {
            const title = document.getElementById('annTitle').value.trim();
            const message = document.getElementById('annMessage').value.trim();

            if (!title) {
                alert('Please enter announcement title');
                return;
            }
            if (title.length > 100) {
                alert('Title must be 100 characters or less');
                return;
            }
            if (!message) {
                alert('Please enter announcement message');
                return;
            }
            if (message.length > 500) {
                alert('Message must be 500 characters or less');
                return;
            }

            const data = {
                title: title,
                message: message
            };

            if (editingAnnounceId) {
                // Update existing announcement
                fetch('/api/admin/announcements/' + editingAnnounceId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(r => r.json())
                .then(d => { 
                    if(d.success) {
                        showNotification('Announcement updated successfully!', 'success');
                        closeAnnouncement();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Error updating announcement', 'error');
                    }
                })
                .catch(e => showNotification('Error: ' + e, 'error'));
            } else {
                // Create new announcement
                fetch('/api/admin/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(r => r.json())
                .then(d => { 
                    if(d.success) {
                        showNotification('Announcement posted successfully!', 'success');
                        closeAnnouncement();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Error posting announcement', 'error');
                    }
                })
                .catch(e => showNotification('Error: ' + e, 'error'));
            }
        }

        function deleteAnnouncement(id) {
            if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                fetch('/api/admin/announcements/' + id, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(d => { 
                        if(d.success) {
                            showNotification('Announcement deleted!', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showNotification('Error deleting announcement', 'error');
                        }
                    })
                    .catch(e => showNotification('Error: ' + e, 'error'));
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#ffca28';
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background-color: ${bgColor};
                color: #000;
                padding: 1rem 1.5rem;
                border: 2px solid #000;
                box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                font-weight: 600;
                font-family: 'PT Sans', sans-serif;
                border-radius: 0;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        // Update announcement count on page load
        document.addEventListener('DOMContentLoaded', () => {
            const announcements = document.querySelectorAll('.announcement-card').length;
            document.getElementById('totalAnnouncements').textContent = announcements;
            document.getElementById('activeAnnouncements').textContent = announcements;
        });

        // Search functionality
        const searchInput = document.getElementById('searchAnnouncements');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const announcements = document.querySelectorAll('.announcement-card');
                
                announcements.forEach(ann => {
                    const title = ann.querySelector('.announcement-title').textContent.toLowerCase();
                    const content = ann.querySelector('.announcement-content').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || content.includes(searchTerm)) {
                        ann.style.display = '';
                    } else {
                        ann.style.display = 'none';
                    }
                });
            });
        }

        window.onclick = function(e) {
            const modal = document.getElementById('announcementModal');
            if (e.target === modal) closeAnnouncement();
        }
    </script>
</body>
</html>
